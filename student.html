<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>Student Dashboard</h1>
            <div class="user-info">
                <span id="userInfo"></span>
                <button id="logoutBtn">Logout</button>
            </div>
        </header>
        
        <main>
            <section class="upload-section">
                <h2>Upload Test Copy</h2>
                <div class="upload-area">
                    <input type="file" id="fileInput" accept="image/*,.pdf" hidden>
                    <label for="fileInput" class="upload-btn">Choose File</label>
                    <span id="fileName">No file selected</span>
                </div>
                <button id="uploadBtn" class="primary-btn">Upload</button>
            </section>
            
            <section class="files-section">
                <h2>My Uploaded Files</h2>
                <div id="filesContainer">
                    <p class="placeholder">Loading files...</p>
                </div>
            </section>
            
            <section class="feedback-section">
                <h2>Teacher's Feedback</h2>
                <div id="feedbackContainer">
                    <p class="placeholder">Loading feedback...</p>
                </div>
            </section>
        </main>
    </div>

    <script>
        // Initialize Firebase - REPLACE WITH YOUR CONFIG
         const firebaseConfig = {
    apiKey: "AIzaSyBQ0CjOoBCqnI4T-bNV29oUPtxpdNq1gdI",
    authDomain: "lawclassescopy.firebaseapp.com",
    projectId: "lawclassescopy",
    storageBucket: "lawclassescopy.firebasestorage.app",
    messagingSenderId: "237369982975",
    appId: "1:237369982975:web:2ce13f052f87ba545231ca",
    measurementId: "G-7E46DDHYKY"
  };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is logged in
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser || currentUser.type !== 'student') {
                window.location.href = 'index.html';
            }
            
            // Get student info from Firebase
            const studentRef = database.ref(`studentInfo/${currentUser.mobile}`);
            studentRef.once('value').then(snapshot => {
                const student = snapshot.val();
                if (!student) {
                    // Student info not found, redirect to login
                    alert('Student information not found. Please login again.');
                    localStorage.removeItem('currentUser');
                    window.location.href = 'index.html';
                    return;
                }
                
                // Display user info
                document.getElementById('userInfo').textContent = `Name: ${student.name}, Mobile: ${currentUser.mobile}`;
                
                // Load files and feedback
                loadFiles();
                loadFeedback();
                
                // Set up real-time listeners
                setupRealtimeListeners();
            }).catch(error => {
                console.error('Error loading student info:', error);
                alert('Error loading student information. Please try again.');
            });
            
            // File selection
            const fileInput = document.getElementById('fileInput');
            const fileName = document.getElementById('fileName');
            const uploadBtn = document.getElementById('uploadBtn');
            
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    fileName.textContent = e.target.files[0].name;
                } else {
                    fileName.textContent = 'No file selected';
                }
            });
            
            // Upload file
            uploadBtn.addEventListener('click', () => {
                if (fileInput.files.length === 0) {
                    alert('Please select a file first');
                    return;
                }
                
                const file = fileInput.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        // Create a reference to the student's files in Firebase
                        const studentFilesRef = database.ref(`studentCopies/${currentUser.mobile}`);
                        
                        // Get current files
                        studentFilesRef.once('value', (snapshot) => {
                            const files = snapshot.val() || [];
                            
                            // Add the new file
                            files.push({
                                fileName: file.name,
                                data: e.target.result,
                                timestamp: new Date().toISOString()
                            });
                            
                            // Save to Firebase
                            studentFilesRef.set(files).then(() => {
                                alert('File uploaded successfully!');
                                fileName.textContent = 'No file selected';
                                fileInput.value = '';
                            }).catch(error => {
                                console.error('Error saving to Firebase:', error);
                                alert('Error uploading file. Please try again.');
                            });
                        });
                    } catch (error) {
                        console.error('Error uploading file:', error);
                        alert('Error uploading file. Please try again.');
                    }
                };
                
                reader.onerror = function() {
                    console.error('Error reading file');
                    alert('Error reading file. Please try again.');
                };
                
                reader.readAsDataURL(file);
            });
            
            // Load student's files
            function loadFiles() {
                const studentFilesRef = database.ref(`studentCopies/${currentUser.mobile}`);
                const container = document.getElementById('filesContainer');
                
                container.innerHTML = '<p class="placeholder">Loading files...</p>';
                
                studentFilesRef.once('value', (snapshot) => {
                    const files = snapshot.val() || [];
                    container.innerHTML = '';
                    
                    if (files.length === 0) {
                        container.innerHTML = '<p class="placeholder">No files uploaded yet</p>';
                    } else {
                        files.forEach(file => {
                            const fileEl = document.createElement('div');
                            fileEl.className = 'file-item';
                            
                            if (file.data.startsWith('data:image')) {
                                const img = document.createElement('img');
                                img.src = file.data;
                                fileEl.appendChild(img);
                            } else {
                                const link = document.createElement('a');
                                link.href = file.data;
                                link.download = file.fileName;
                                link.textContent = `Download: ${file.fileName}`;
                                fileEl.appendChild(link);
                            }
                            
                            const info = document.createElement('div');
                            info.className = 'file-info';
                            info.innerHTML = `
                                <p><strong>File:</strong> ${file.fileName}</p>
                                <p><strong>Uploaded:</strong> ${new Date(file.timestamp).toLocaleString()}</p>
                            `;
                            fileEl.appendChild(info);
                            
                            container.appendChild(fileEl);
                        });
                    }
                }).catch(error => {
                    console.error('Error loading files:', error);
                    container.innerHTML = '<p class="placeholder">Error loading files</p>';
                });
            }
            
            // Load feedback
            function loadFeedback() {
                const feedbackRef = database.ref(`teacherFeedbacks/${currentUser.mobile}`);
                const container = document.getElementById('feedbackContainer');
                
                container.innerHTML = '<p class="placeholder">Loading feedback...</p>';
                
                feedbackRef.once('value', (snapshot) => {
                    const feedback = snapshot.val();
                    container.innerHTML = '';
                    
                    if (feedback) {
                        const feedbackEl = document.createElement('div');
                        feedbackEl.className = 'feedback-item';
                        
                        if (feedback.data.startsWith('data:image')) {
                            const img = document.createElement('img');
                            img.src = feedback.data;
                            feedbackEl.appendChild(img);
                        } else {
                            const link = document.createElement('a');
                            link.href = feedback.data;
                            link.download = feedback.fileName;
                            link.textContent = `Download: ${feedback.fileName}`;
                            feedbackEl.appendChild(link);
                        }
                        
                        const date = document.createElement('p');
                        date.textContent = `Received: ${new Date(feedback.timestamp).toLocaleString()}`;
                        feedbackEl.appendChild(date);
                        
                        container.appendChild(feedbackEl);
                    } else {
                        container.innerHTML = '<p class="placeholder">No feedback available yet</p>';
                    }
                }).catch(error => {
                    console.error('Error loading feedback:', error);
                    container.innerHTML = '<p class="placeholder">Error loading feedback</p>';
                });
            }
            
            // Set up real-time listeners for automatic updates
            function setupRealtimeListeners() {
                // Listen for file updates
                database.ref(`studentCopies/${currentUser.mobile}`).on('value', (snapshot) => {
                    loadFiles();
                });
                
                // Listen for feedback updates
                database.ref(`teacherFeedbacks/${currentUser.mobile}`).on('value', (snapshot) => {
                    loadFeedback();
                });
            }
            
            // Logout
            document.getElementById('logoutBtn').addEventListener('click', () => {
                localStorage.removeItem('currentUser');
                window.location.href = 'index.html';
            });
        });
    </script>
</body>
</html>
